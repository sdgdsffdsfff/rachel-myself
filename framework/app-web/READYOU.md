##前端框架

框架结构如下：

```javascript
--app-web
    --app
        --config
            --local
                --page.php 外层配置
                --page.php 默认配置
        --controllers
            --SellerControler.php（php的后台controller层）
        --helpers
            --Resource.php 用于自动生成js和css文件（生成文件目录是在public/www/）
        --views
            --layouts
                --touch.blade.php(html页面的layout)
            --partials
                --autocomplete.blade.php(组件的html页面)
            --touch
                --(user/seller)
                    --commission.blade.php

    --public
        --tools(用于自动生成build.js文件，且node r.js -o build.js，合并压缩业务js和css代码)
            --src
                --autoGenerate.js(自动生成www/下的js和css文件的主体脚本)
                --build.tpl.js(autoGenerate.js执行时，用作生成build.js的模板)
            --boot.js(node boot.js，boot.js会调用src/autoGenerate.js)
            --build.js(autoGenerate.js生成的文件结果)
            --r.js
        --www
            --css
            --example
            --iconfont
            --image
            --js
                --controller
                --lib
                    --zepto.js等
                --model
                --modules(组件js部分)
                    --ui.autocomplete.js等
                --service(与后台数据交互的js代码)
                    --commissionService.js等

            --commission.css
            --commission.js
            --common.css
            --common.js

        --www-built(build以后生成的代码)
            --commission.js
            --commission.css(正式上线以后，页面直接调用的是这个目录下的js和css文件)
            --common.js
            --common.css

```


####针对上述框架，做如下解析：

一。配置层数

默认配置是：app-web/app/config/page.php文件

外层配置：app-web/app/config/local/page.php文件中的配置会覆盖默认文件中的配置。


二。关于requirejs打包

1.  我们是通过php文件：app-web/app/helpers/Resource.php中的方法autoGenerate()自动生成文件到app-web/public/www目录下，包括js和css文件，如：www/my-property.js和www/my-property.css文件。

www/my-property.js 文件内容如下：
```javascript
//This code is generated by PHP.
//Load common code that includes config, then load the app logic for this page.
require(['./common'], function (common) {
   require(['app/my-property']);
});
```

www/my-property.css 文件内容：
```javascript
/* This code is generated by PHP. */
@import url('css/my-property.css');
```


2.  以上的方法autoGenerate()，调用是在touch.blade.php文件中。用$debug（app-web/app/config/local/page.php配置文件决定该变量的值）作为判断是否生成。


3.  生成该文件的my-property.js和css文件的目的是(以js为例)：因为在打包时需要将一个页面的业务js代码（可能多个业务js文件）打包成一个js文件，所以就需要在build.js文件中modules部分，加入该js文件的配置。


4.  node app-web/public/tools/boot.js 。执行该文件就会自动在app-web/public/tools目录下生成build.js文件，用于后面打包：node r.js -o build.js。

boot.js文件的目的时用于生成build.js文件中的modules部分（各个页面生成对应的一个js文件）。
```javascript
原理：
 获取所有依赖项（其实是每个页面在build.js的modules 数组中元素），如（它是一个对象）：
{
            "name": "../comment",
            "include": [
                "app/schedule-detail"
            ],
            "exclude": [
                "../common"
            ]
  },

步骤：读取目录www下所有文件（非文件夹），拿到文件名（json的name部分），读取该文件内容，通过正则匹配获取该js模块的依赖（即include内容）。最后可以将上述的json格式作模块，用读取的文件内容填充。这样就会拿到该json，并且用数据组合。我们也把build.js，用一个模板（模板对象，利于获取modules部分，通过tpl.modules）拿到modules已有部分，然后再组合前面的数组json。这样一个新的build.js模块对象，将其JSON.stringify以后，并写入对应文件（即build.js文件）。完成！
```

5. 我们的开发环境还是打包以后的环境，页面调用的都是www下的对应业务js文件。开发环境，是php自动生成的require js文件，该文件会因为requirejs的require内容自动加载其他js文件（会加载多个js文件）。打包代码后的测试环境，打包后的对应业务js文件就在www下，所以加载完该文件就ok了。


6.  我们框架中，自动生成文件的源码：app-web/app/helpers/Resource.php

6.1  我们自动生成后的文件名（放在www/目录下），是在app/controllers/对应业务controller文件的函数（通过routes.php查找）。如下（文件名取的是下面的变量file_css和file_js的值）：
```javascript
public function commission()
    {
        $this->file_css = ‘commission-new';
        $this->file_js = ‘commission-new';
        $this->title = '委托房源';
        return $this->view('touch.user.seller.commission');
    }
```

6.2  以上6.1说的生成的文件内容，重点是require的内容，其实是在每个xxx.blade.php文件开头，如下：
```javascript
<?php Aifang\Web\Resource::addJS(array('app/commission'));?>
<?php Aifang\Web\Resource::addCSS(array('css/commission'));?>
```
使用以上说的Resource.php文件中的函数addJS和addCSS。将需要的组件（js和对应css算是一套）加入到require中。

案例：
1).    commission.blade.php中有开头：
```javascript
<?php Aifang\Web\Resource::addJS(array('app/commission'));?>
<?php Aifang\Web\Resource::addCSS(array('css/commission'));?>
```
且在该文件中有@include('partials.autocomplete’)

 2)     在文件autocomplete.blade.php文件开头，也有如下：
```javascript
<?php Aifang\Web\Resource::addJS(array('ui.autocomplete'));?>
<?php Aifang\Web\Resource::addCSS(array('css/autocomplete'));?>
```

3）    所以最后我们生成的www/commission-new.js文件中，有
```javascript
require(['./common'], function (common) {
   require(['app/commission', 'ui.autocomplete']);
});
```



